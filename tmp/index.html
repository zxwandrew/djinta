<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

		<title>create</title>

		<meta name="viewport" content="width=device-width; initial-scale=1.0" />

		<!-- Replace the following with root of your domain and delete these references

		<link rel="apple-touch-icon" href="/media/apple-touch-icon.png" />
		<link rel="stylesheet" type="text/css" href="/static/css/style.css" />
		<link rel="shortcut icon" href="static/favicon.ico" />
		-->

		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<link rel="shortcut icon" href="favicon.ico" />
		<script type="text/javascript" src="file/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="file/modernizr-2.5.3.js"></script>
		<script src="file/iphone-style-checkboxes.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="file/jquery.json-2.3.min.js"></script>
		<!--
		<script type="text/javascript" src="file/jquery.event.drag.live-2.2.js"></script>-->
		<script type="text/javascript" src="file/jquery.event.drag-2.2.js"></script>
		<script type="text/javascript" src="file/display_results.js"></script>

		<!--resizing mostly-->
		<script type="text/javascript">
			var DrawingInterfaceHeight, TrueHeight, TrueWidth, DrawingHeight, DrawingWidth;
			var ObjNum = 0;
			var Snapping = 'false';
			var AllParts = new Array;
			var AllPartsJSON;
			var pastselect = new Array;

			function NearPart(AbsCoordX, AbsCoordY) {
				for( i = 0; i < AllParts.length; i++) {
					switch(AllParts[i].type) {
						case "member":

							if(AbsCoordX >= AllParts[i].x1 && AbsCoordX <= AllParts[i].x2 || AbsCoordX <= AllParts[i].x1 && AbsCoordX >= AllParts[i].x2) {
								var slope = (AllParts[i].y2 - AllParts[i].y1) / (AllParts[i].x2 - AllParts[i].x1);
								if(slope > -8 && slope < 8) {
									var intercept;
									intercept = AllParts[i].y1 - slope * AllParts[i].x1
									var Y = AbsCoordX * slope + intercept;
									if(Y + 4 >= AbsCoordY && Y - 4 <= AbsCoordY) {
										//$('#CommandBar').html("Member: "+slope);
										return i;
									}
								} else {//flip it around
									var slope = (AllParts[i].x2 - AllParts[i].x1) / (AllParts[i].y2 - AllParts[i].y1);
									var intercept;
									intercept = AllParts[i].x1 - slope * AllParts[i].y1
									var X = AbsCoordY * slope + intercept;
									if(X + 5 >= AbsCoordX && X - 5 <= AbsCoordX) {
										if(AbsCoordY >= AllParts[i].y1 && AbsCoordY <= AllParts[i].y2 || AbsCoordY <= AllParts[i].y1 && AbsCoordY >= AllParts[i].y2) {
											return i;
										}
									}
								}

							}
					}//end switch
				}
				return -1;
			}

			function DragHighlightPart(CloseTo) {
				for( j = 0; j < CloseTo.length; j++) {
					switch(AllParts[CloseTo[j]].type) {
						case "member":
							//Highlight path
							var obj = document.getElementById("ClickHighlightCanvas");
							var ctx = obj.getContext("2d");
							ctx.beginPath();
							ctx.moveTo(AllParts[CloseTo[j]].x1, AllParts[CloseTo[j]].y1);
							ctx.lineTo(AllParts[CloseTo[j]].x2, AllParts[CloseTo[j]].y2);
							ctx.lineWidth = 6;
							ctx.strokeStyle = "#8ED6FF";
							ctx.stroke();
					}
				}
			}

			function ClearDragHighlight() {
				var obj = document.getElementById("ClickHighlightCanvas");
				var ctx1 = obj.getContext("2d");
				ctx1.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
			}

			function ClickHighlightPart(CloseTo) {
				switch(AllParts[CloseTo].type) {
					case "member":
						//Highlight path
						var obj = document.getElementById("ClickHighlightCanvas");
						var ctx = obj.getContext("2d");
						ctx.beginPath();
						ctx.moveTo(AllParts[CloseTo].x1, AllParts[CloseTo].y1);
						ctx.lineTo(AllParts[CloseTo].x2, AllParts[CloseTo].y2);
						ctx.lineWidth = 6;
						ctx.strokeStyle = "#8ED6FF";
						ctx.stroke();
				}
			}

			function ClearClickHighlight() {
				var obj = document.getElementById("ClickHighlightCanvas");
				var ctx1 = obj.getContext("2d");
				ctx1.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
			}

			function HoverHighlightPart(CloseTo) {
				switch(AllParts[CloseTo].type) {
					case "member":
						//Highlight path
						var obj = document.getElementById("HoverHighlightCanvas");
						var ctx = obj.getContext("2d");
						ctx.beginPath();
						ctx.moveTo(AllParts[CloseTo].x1, AllParts[CloseTo].y1);
						ctx.lineTo(AllParts[CloseTo].x2, AllParts[CloseTo].y2);
						ctx.lineWidth = 4;
						ctx.strokeStyle = "#F21800";
						ctx.stroke();
				}
			}

			function ClearHoverHighlight() {
				var obj = document.getElementById("HoverHighlightCanvas");
				var ctx1 = obj.getContext("2d");
				ctx1.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
			}

			function UpdateMemberProperty(form, match) {
				//alert(matchingselected);
				var matchingselected = match.split("X");
				for( j = 0; j < matchingselected.length; j++) {
					AllParts[matchingselected[j]].i = form.i.value;
					AllParts[matchingselected[j]].e = form.e.value;
					AllParts[matchingselected[j]].area = form.area.value;
				}
			}

			//NOT COMPLETE YET!!!!
			function UpdateDForceProperty(form, match) {
				var matchingselected = match.split("X");
				for( j = 0; j < matchingselected.length; j++) {
					AllParts[matchingselected[j]].f1 = form.f1.value;
					AllParts[matchingselected[j]].f2 = form.f2.value;

					AllParts[matchingselected[j]].r1 = form.r1.value;
					AllParts[matchingselected[j]].r2 = form.r2.value;
					AllParts[matchingselected[j]].direction = form.direction.value;

					
					f1 = form.f1.value;
					f2 = form.f2.value;
					r1 = form.r1.value;
					r2 = form.r2.value;
					direction = form.direction.value
					
					pn1=1
					pn2=1
					
					if(f1<0){
						pn1=-1
					}
					if(f2<0){
						pn2=-1
					}

					//get canvas
					var obj = document.getElementById("obj" + matchingselected[j]);
					var ctx = obj.getContext("2d");
					ctx.beginPath();
					ctx.stroke();
					ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);

					//start drawing
					ctx.lineWidth = 3;
					if(direction=='Global-Y'){
						ctx.strokeStyle="Red"	
						AllParts[matchingselected[j]].slope = 'infinity'			
					}else if(direction=='Global-X'){
						ctx.strokeStyle='Orange'
						AllParts[matchingselected[j]].slope = 0;
					}else if(direction=='Local-Y'){
						if(slope==0){
							AllParts[matchingselected[j]].slope = 'infinity'
						}else{
							AllParts[matchingselected[j]].slope = -1/slope;
						}
						ctx.strokeStyle='Green'	
					}else if(direction=='Local-X'){
						ctx.strokeStyle='Purple'
						AllParts[matchingselected[j]].slope = slope;
					}
					
					x1 = Math.min(AllParts[AllParts[matchingselected[j]].onmember].x1, AllParts[AllParts[matchingselected[j]].onmember].x2)
					x2 = Math.max(AllParts[AllParts[matchingselected[j]].onmember].x1, AllParts[AllParts[matchingselected[j]].onmember].x2)
					if(Math.min(AllParts[AllParts[matchingselected[j]].onmember].x1, AllParts[AllParts[matchingselected[j]].onmember].x2) == AllParts[AllParts[matchingselected[j]].onmember].x1) {
						y1 = AllParts[AllParts[matchingselected[j]].onmember].y1
						y2 = AllParts[AllParts[matchingselected[j]].onmember].y2
					} else {
						y1 = AllParts[AllParts[matchingselected[j]].onmember].y2
						y2 = AllParts[AllParts[matchingselected[j]].onmember].y1
					}
					var slope = (y2 - y1) / (x2 - x1);

					//start point
					X44 = Math.sqrt(Math.pow((r1*15), 2) / (1 + (Math.pow((slope), 2))))
					Y44 = X44 * slope
					if(slope == 0) {
						X44 = r1*15
						Y44 = 0
					} else if(slope == Number.POSITIVE_INFINITY) {
						X44 = 0
						Y44 = r1*15
					} else if(slope == Number.NEGATIVE_INFINITY) {
						X44 = 0
						Y44 = -r1*15
					}					
					x1=x1+X44
					y1=y1+Y44
					
					//how much to move?
					if(f1>f2){
						leftheight=45
						rightheight=15
					}else if(f1<f2){
						rightheight=45
						leftheight=15
					}else{
						leftheight=15
						rightheight=15
					}
					length=Math.abs(r1-r2)*15
					totallength=Math.sqrt(Math.pow((Math.abs(x1-x2)),2)+Math.pow((Math.abs(y1-y2)),2))
					if(r1<0){
						r1=0
					}
					if((r1*15+length)>totallength){
						length=totallength-r1
					}
					
					//first turn
					X12 = Math.sqrt(Math.pow(leftheight, 2) / (1 + (Math.pow((1 / (-1 * slope)), 2))))
					Y12 = X12 * (1 / (-1 * slope))
					if(slope == 0) {
						X12 = 0
						Y12 = -1*leftheight
					} else if(slope == Number.POSITIVE_INFINITY) {
						X12 = -1*leftheight
						Y12 = 0
					} else if(slope == Number.NEGATIVE_INFINITY) {
						X12 = leftheight
						Y12 = 0
					}
					
					//get the distance
					X21 = Math.sqrt(Math.pow(length, 2) / (1 + (Math.pow((slope), 2))))
					Y21 = X21 * slope
					if(slope == Number.POSITIVE_INFINITY) {
						X21 = 0
						Y21 = length
					} else if(slope == Number.NEGATIVE_INFINITY) {
						X21 = 0
						Y21 = -1*length
					}
					
					//second turn
					X22 = Math.sqrt(Math.pow(rightheight, 2) / (1 + (Math.pow((1 / (-1 * slope)), 2))))
					Y22 = X22 * (1 / (-1 * slope))
					if(slope == 0) {
						X22 = 0
						Y22 = -1*rightheight
					} else if(slope == Number.POSITIVE_INFINITY) {
						X22 = -1*rightheight
						Y22 = 0
					} else if(slope == Number.NEGATIVE_INFINITY) {
						X22 = rightheight
						Y22 = 0
					}
					//draw box
					ctx.beginPath();
					ctx.moveTo(x1, y1);
					if(y1 > y2) {
						ctx.lineTo(x1 - X12, y1 - Y12);
						ctx.moveTo(x1 + X21, y1 + Y21);
						ctx.lineTo(x1+X21-X22, y1+Y21-Y22);
						ctx.lineTo(x1 - X12, y1 - Y12)
					} else {
						ctx.lineTo(x1 + X12, y1 + Y12);
						ctx.moveTo(x1 + X21, y1 + Y21);
						ctx.lineTo(x1+X21+X22, y1+Y21+Y22);
						ctx.lineTo(x1 + X12, y1 + Y12)
					}
					ctx.stroke();
					
					AllParts[matchingselected[j]].servx1 = x1/15;
					AllParts[matchingselected[j]].servy1 = (DrawingHeight-y1-1)/15;
					
					AllParts[matchingselected[j]].servx2 = (x1 + X21)/15
					AllParts[matchingselected[j]].servy2 = (DrawingHeight-(y1 + Y21)-1)/15;
				
					
					
					//end box
					
					//draw lines
					if(direction=='Global-Y'){
						/*
						for(i=1;i<((length/15))+1;i++){
							X33 = Math.sqrt(Math.pow(i*15, 2) / (1 + (Math.pow((slope), 2))))
							Y33 = X33 * slope
							if(slope == Number.POSITIVE_INFINITY) {
								X33 = 0
								Y33 = i*15
							} else if(slope == Number.NEGATIVE_INFINITY) {
								X33 = 0
								Y33 = -15*i
							}
							ctx.beginPath();
							ctx.moveTo(x1+X33, y1+Y33);
							ctx.lineTo(x1+X33, y1+Y33-15);
							ctx.stroke()
						}*/
						
					}else if(direction=='GlobalX'){
						
					}else if(direction=='LocalY'){
						
					}else if(direction=='LocalX'){
						
					}

				}
			}

			function UpdateForceProperty(form, match) {
				var matchingselected = match.split("X");
				for( j = 0; j < matchingselected.length; j++) {
					AllParts[matchingselected[j]].magnitude = form.magnitude.value;
				}
			}

			function DisplayProperty(selected) {
				$('#PropertyBar').css("visibility", "visible");

				//alert(AllParts[selected[0]].type);

				if(AllParts[selected[0]].type == "member") {
					var e = AllParts[selected[0]].e;
					var i = AllParts[selected[0]].i;
					var area = AllParts[selected[0]].area;
					var matchingselected = new Array;

					//check if they all have the same property, if not break and return first
					for( j = 0; j < selected.length; j++) {
						if(e != AllParts[selected[j]].e || i != AllParts[selected[j]].i || area != AllParts[selected[j]].area) {
							matchingselected[0] = selected[0];
							break;
						} else {
							matchingselected[j] = selected[j];
						}
					}

					//check if one or all and create message
					if(matchingselected.length == 1) {
						var displaymessage = '<h4>Properties</h4><p>Editing: ' + selected[0] + '</p><br/> <form> i: <input class="Property-Textbox" type="text" name="i" value="' + i + '"/>';
					} else {
						var displaymessage = '<h4>Properties</h4><p>Editing: ';
						for( k = 0; k < matchingselected.length; k++) {
							displaymessage += matchingselected[k] + ', ';
						}
						displaymessage += '</p><br/> <form> i: <input class="Property-Textbox" type="text" name="i" value="' + i + '"/>';
					}
					//modify matchingselected so it is passable
					var tempselected = "'" + matchingselected.join('X') + "'";

					//Generate form
					displaymessage += 'e: <input class="Property-Textbox" type="text" name="e" value="' + e + '"/>';
					displaymessage += 'area: <input class="Property-Textbox" type="text" name="area" value="' + area + '"/><br/>';
					displaymessage += ' <input type="button" name="updateproperty" value="Update" onClick="UpdateMemberProperty(this.form, ' + tempselected + ')"/></form>';
					$('#PropertyBar').html(displaymessage);
				}//end member selection
				
else if(AllParts[selected[0]].type == "XForce" || AllParts[selected[0]].type == "YForce" || AllParts[selected[0]].type == "MForce") {

					var matchingselected = new Array;
					var displaymessage = '<h4>Properties</h4><p>Editing Forces: ';
					for( k = 0; k < selected.length; k++) {
						if(AllParts[selected[0]].type == "XForce" || AllParts[selected[0]].type == "YForce" || AllParts[selected[0]].type == "MForce") {
							matchingselected.push(selected[k]);
							displaymessage += selected[k] + ', ';
						}
					}
					displaymessage += '</p><br/> <form> Magnitude: <input class="Property-Textbox" type="text" name="magnitude" value="' + AllParts[selected[0]].magnitude + '"/>';
					var tempselected = "'" + matchingselected.join('X') + "'";
					displaymessage += ' <input type="button" name="updateproperty" value="Update" onClick="UpdateForceProperty(this.form, ' + tempselected + ')"/></form>';
					$('#PropertyBar').html(displaymessage);

				}
				//end force selection

				//start D Force Selection
				else if(AllParts[selected[0]].type == 'DForce') {
					var matchingselected = new Array;
					var f1 = AllParts[selected[0]].f1
					var f2 = AllParts[selected[0]].f2
					var r1 = AllParts[selected[0]].r1
					var r2 = AllParts[selected[0]].r2
					var direction = AllParts[selected[0]].direction

					//check if they all have the same property, if not break and return first
					for( j = 0; j < selected.length; j++) {
						if(f1 != AllParts[selected[j]].f1 || f2 != AllParts[selected[j]].f2 || direction != AllParts[selected[j]].direction) {
							matchingselected[0] = selected[0];
							break;
						} else {
							matchingselected[j] = selected[j];
						}
					}

					//check one or all and create message
					if(matchingselected.length == 1) {
						var displaymessage = '<h4>Properties</h4><p>Editing: ' + selected[0] + 'on member ' + AllParts[selected[0]].onmember + '<br/> <form> Start Magnitude: <input class="Property-Textbox" type="text" name="f1" value="' + f1 + '"/>';
					} else {
						var displaymessage = '<h4>Properties</h4><p>Editing: ';
						for( k = 0; k < matchingselected.length; k++) {
							displaymessage += selected[k] + 'on member' + AllParts[selected[k]].onmember + '<br/>';
						}
						displaymessage += '</p><br/> <form> Start Magnitude: <input class="Property-Textbox" type="text" name="f1" value="' + f1 + '"/>';
					}
					//modify matchingselected so it is passable
					var tempselected = "'" + matchingselected.join('X') + "'";

					//Generate form
					displaymessage += 'End Magnitude: <input class="Property-Textbox" type="text" name="f2" value="' + f2 + '"/>';
					displaymessage += 'Position <br/>(Relative to Member)<br/> Start Point: <input class="Property-Textbox" type="text" name="r1" value="' + r1 + '"/><br/>';
					displaymessage += 'End Point: <input class="Property-Textbox" type="text" name="r2" value="' + r2 + '"/><br/>';
					//Generate the dropdown list
					DirectionArray = ["Global-Y", "Global-X", "Local-Y", "Local-X"]
					displaymessage += 'Orientation: <select class="Property-Textbox" name="direction" value="' + direction + '">';
					for( l = 0; l < DirectionArray.length; l++) {
						if(direction == DirectionArray[l]) {
							displaymessage += '<option value="' + DirectionArray[l] + '" selected>' + DirectionArray[l] + '</option>'
						} else {
							displaymessage += '<option value="' + DirectionArray[l] + '">' + DirectionArray[l] + '</option>'
						}
					}
					displaymessage += '</select><br/>';

					displaymessage += ' <input type="button" name="updateproperty" value="Update" onClick="UpdateDForceProperty(this.form, ' + tempselected + ')"/></form>';
					$('#PropertyBar').html(displaymessage);

				}
				//END D force selection

			}

			function HideProperty() {
				$('#PropertyBar').css("visibility", "hidden");
			}

			function DeletePart(pastselect) {
				for( j = 0; j < pastselect.length; j++) {
					var obj = document.getElementById("obj" + pastselect[j]);
					var ctx = obj.getContext("2d");
					ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
					AllParts[pastselect[j]] = 0;
				}

			}

			//Will need to be improved!!!!, currently works only if the end point is selected!!!
			function ContainPart(minx, miny, maxx, maxy) {
				//work in absolute coordinate
				var select = new Array;
				for( i = 0; i < AllParts.length; i++) {
					switch(AllParts[i].type) {
						case "member":
							//check
							if((minx < AllParts[i].x1 && maxx > AllParts[i].x1 && miny < AllParts[i].y1 && maxy > AllParts[i].y1) || (minx < AllParts[i].x2 && maxx > AllParts[i].x2 && miny < AllParts[i].y2 && maxy > AllParts[i].y2)) {
								select.push(i);
								ClickHighlightPart(i);
							}

					}//end switch
				}
				return select;
			}

			//select with click (multi with shift)
			function ClickSelect(status) {
				var gridcanvas = document.getElementById('GridCanvas');
				var context = gridcanvas.getContext('2d');
				var shifted = 0;

				var ClickHandler = function(evt) {
					//alert("here");
					var clickPos = getMousePos(gridcanvas, evt, $(".Viewport-Scrollable"), DrawingHeight);
					var CloseTo = NearPart(clickPos.absoluteX, clickPos.absoluteY);
					if(CloseTo != -1 && evt.shiftKey == 0) {
						//keep track of list
						window.pastselect.length = 0;
						window.pastselect.push(CloseTo);
						//Unhighlight then highlight
						ClearClickHighlight();
						ClickHighlightPart(CloseTo);
						//Display the property bar
						DisplayProperty(window.pastselect);
					} else if(CloseTo != -1 && evt.shiftKey == 1) {
						//keep track of list
						window.pastselect.push(CloseTo);
						//highlight
						ClickHighlightPart(CloseTo);
						//Display the property bar
						DisplayProperty(window.pastselect);
					} else {
						window.pastselect.length = 0;
						ClearClickHighlight();
						ClearDragHighlight();
						//Hide Property bar
						HideProperty();
					}
				}
				if(status == 'Cancel') {
					$("#GridCanvas").unbind('click', ClickHandler);
				} else {
					$("#GridCanvas").bind('click', ClickHandler);
				}

				var DeleteHandler = function(e) {
					if(e.keyCode == 46) {
						HideProperty();
						ClearClickHighlight(window.pastselect);
						ClearHoverHighlight(window.pastselect);
						DeletePart(window.pastselect);
					}
				}
				$(document).bind('keydown', DeleteHandler);
			}

			function DragSelect() {
				var gridcanvas = document.getElementById('GridCanvas');
				var context = gridcanvas.getContext('2d');

				$('#GridCanvas').drag("start", function(ev, dd) {
					window.pastselect.length = 0;
					HideProperty();
					return $('<div class="Drag-Selection" />').css('opacity', .6).appendTo($(".Obj-Canvas"));

				}).drag(function(ev, dd) {
					var mousePos = getMousePos(gridcanvas, ev, $(".Viewport-Scrollable"), DrawingHeight);

					var y1 = Math.min(mousePos.absoluteY, ($(".Viewport-Scrollable").scrollTop() + (dd.startY - 41 + window.pageYOffset)));
					var x1 = Math.min(mousePos.absoluteX, ($(".Viewport-Scrollable").scrollLeft() + (dd.startX - 213 + window.pageXOffset)));
					var he = Math.abs(mousePos.absoluteY - ($(".Viewport-Scrollable").scrollTop() + (dd.startY - 41 + window.pageYOffset)));
					var wi = Math.abs(mousePos.absoluteX - ($(".Viewport-Scrollable").scrollLeft() + (dd.startX - 213 + window.pageXOffset)));

					$(dd.proxy).css({
						top : y1,
						left : x1,
						height : he,
						width : wi
					});
					//Check within rectangle or not, also takes care of highlighting and show property
					var x2 = x1 + wi;
					var y2 = y1 + he;
					window.pastselect.length = 0;
					window.pastselect = ContainPart(x1, y1, x2, y2);
					ClearClickHighlight();
					if(window.pastselect.length != 0) {
						DragHighlightPart(window.pastselect);
						DisplayProperty(window.pastselect);
					}

				}).drag("end", function(ev, dd) {
					$(dd.proxy).remove();
				});

				var DeleteHandler = function(e) {
					if(e.keyCode == 46) {
						HideProperty();
						ClearDragHighlight();
						ClearDragHighlight(window.pastselect);
						DeletePart(window.pastselect);
					}
				}
				$(document).bind('keydown', DeleteHandler);
			}

			function init() {
				//snaponoff
				$("#Snap-on-off").attr("autocomplete", "off");
				var onchange_checkbox = ($('#Snap-on-off')).iphoneStyle({
					onChange : function(elem, value) {
						window.Snapping = value.toString();
						//('#CommandBar').html(value.toString());
					}
				});
				//For Drawing-Interface
				DrawingInterfaceHeight = $(window).height() - 62;
				$(".Drawing-Interface").css("height", DrawingInterfaceHeight);
				
				//For the results, initially hidden
				$(".Result-Background").css("height", DrawingInterfaceHeight);
				$(".Result-Pane").css("height", DrawingInterfaceHeight);

				//For Viewport
				TrueHeight = $(window).height();
				TrueWidth = $(window).width();
				$(".Viewport").css("height", TrueHeight);
				$(".Viewport").css("width", TrueWidth);

				//For Drawing-Canvas
				DrawingHeight = (0.75 * ($(window).height())) - (0.75 * ($(window).height()) % 75) + 1;
				DrawingWidth = (0.75 * ($(window).width())) - (0.75 * ($(window).width()) % 75) + 1;
				$(".Drawing-Canvas").css("height", DrawingHeight);
				$(".Drawing-Canvas").css("width", DrawingWidth);

				//Generate Highlight Canvas
				str1 = '<canvas id="ClickHighlightCanvas" class="Highlight-Canvas" width="' + window.DrawingWidth + '" height="' + window.DrawingHeight + '" style="top:0px; left: 0px; position: absolute;"></canvas>';
				$(str1).appendTo($(".Obj-Canvas"));
				str1 = '<canvas id="HoverHighlightCanvas" class="Highlight-Canvas" width="' + window.DrawingWidth + '" height="' + window.DrawingHeight + '" style="top:0px; left: 0px; position: absolute;"></canvas>';
				$(str1).appendTo($(".Obj-Canvas"));
				str1 = '<canvas id="DragHighlightCanvas" class="Highlight-Canvas" width="' + window.DrawingWidth + '" height="' + window.DrawingHeight + '" style="top:0px; left: 0px; position: absolute;"></canvas>';
				$(str1).appendTo($(".Obj-Canvas"));

				//Coordinate Tracker(1)
				var gridcanvas = document.getElementById('GridCanvas');
				var context = gridcanvas.getContext('2d');

				gridcanvas.addEventListener('mousemove', function(evt1) {
					var mousePos = getMousePos(gridcanvas, evt1, $(".Viewport-Scrollable"), DrawingHeight);
					//divide by 15?
					var adjustedX = (mousePos.adjustedX / 15).toFixed(3);
					var adjustedY = (mousePos.adjustedY / 15).toFixed(3);
					var message = "Mouse position: " + adjustedX + "," + adjustedY + "<br/>" + "Snap position:" + mousePos.snapX + "," + mousePos.snapY;
					$('#CoordinateBar').html(message);
					var CloseTo = NearPart(mousePos.absoluteX, mousePos.absoluteY);
					if(CloseTo != -1) {
						ClearHoverHighlight();
						HoverHighlightPart(CloseTo);
					} else {
						ClearHoverHighlight();
					}
				}, true);

				//Generate divs for Drawing
				for( i = 0; i < DrawingHeight / 15; i++) {
					if(i % 5 != 0) {
						var str1 = "<div style='z-index: 3; position: absolute; left: 0px; right: 0px; top: "
						var str2 = i * 15;
						var str3 = "px; height: 1px; background: none repeat scroll 0% 0% rgba(0, 87, 150, 0.3);'></div>"
						str1 = str1.concat(str2).concat(str3);
						$(str1).appendTo($(".Drawing-Canvas"))
					} else {
						var str1 = "<div style='z-index: 3; position: absolute; left: 0px; right: 0px; top: "
						var str2 = i * 15;
						var str3 = "px; height: 1px; background: none repeat scroll 0% 0% rgba(0, 87, 150, 0.9);'></div>"
						str1 = str1.concat(str2).concat(str3);
						$(str1).appendTo($(".Drawing-Canvas"))
					}
				}

				for( i = 0; i < DrawingWidth / 15; i++) {
					if(i % 5 != 0) {
						var str1 = "<div style='z-index: 3; position: absolute; top: 0px; bottom: 0px; left: "
						var str2 = i * 15;
						var str3 = "px; width: 1px; background: none repeat scroll 0% 0% rgba(0, 87, 150, 0.3);'></div>"
						str1 = str1.concat(str2).concat(str3);
						$(str1).appendTo($(".Drawing-Canvas"))
					} else {
						var str1 = "<div style='z-index: 3; position: absolute; top: 0px; bottom: 0px; left: "
						var str2 = i * 15;
						var str3 = "px; width: 1px; background: none repeat scroll 0% 0% rgba(0, 87, 150, 0.9);'></div>"
						str1 = str1.concat(str2).concat(str3);
						$(str1).appendTo($(".Drawing-Canvas"))
					}
				}

				//Get Height on resize
				$(window).bind("resize", resizeWindow);
				function resizeWindow(e) {
					DrawingInterfaceHeight = $(window).height() - 62;
					$(".Drawing-Interface").css("height", DrawingInterfaceHeight);
				}

			}

		</script>

	</head>

	<body id="DrawingBody" onload="init(), ClickSelect(), DragSelect();">
		<nav id="DrawingMenu">
			<ul>
				<li>
					<a href="#">File</a>
					<ul>
						<li>
							<a href="#">New</a>
						</li>
						<li>
							<a href="#" onclick="javascript:SaveDrawing()">Save</a>
						</li>
					</ul>
				</li>
				<li>
					<a href="#">Edit</a>
				</li>
				<li>
					<a href="#">Options</a>
					<ul>
						<li>
							<a href="#">Snaping On/Off</a>
						</li>
					</ul>
				</li>
				<li>
					<a href="#" onclick="send_form()" >Calculate</a>
				</li>
				<li>
					<a href="javascript:ShowResult()">Results</a>
				</li>
			</ul>

		</nav>

		<script type="text/javascript">
			(function($) {

				//cache nav
				var nav = $("#DrawingMenu");
				//add indicators and hovers to submenu parents
				nav.find("li").each(function() {
					if($(this).find("ul").length > 0) {

						//show subnav on hover
						$(this).mouseenter(function() {
							$(this).find("ul").stop(true, true).slideDown();
						});

						//hide submenus on exit
						$(this).mouseleave(function() {
							$(this).find("ul").stop(true, true).slideUp();
						});
					}
				});
			})(jQuery);
		</script>

		<div class="Drawing-Interface">
			<div class="Result-Background">
				<div class ="Result-Pane">
					<a href='javascript: HideResult()'>Back To Drawing</a>
					<p>No Data Yet!</p>
					<br/>
				</div>
			</div>
			
			<div class="Tool-Bar">
				<div class="Tool-Bar-Slider Scrollable">

					<div class="Panel" id="SnapSwitch">
						<h3>Snapping</h3>
						<div class="PanelContent" id="SnapSwitchContent">
							<br/>
							<input type="checkbox" id="Snap-on-off" value="false"/>
							<br/>
						</div>
					</div>

					<div class="Panel" id="StrucutralPanel">
						<h3>Structural Panel</h3>
						<div class="PanelContent" id="StrucutralPanelContent">
							<!--Truss Block-->
							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreateMember();" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable MemberBlock" name="MemberBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>
							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreatePoint('Hinge');" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable Hinge-Block" name="HingeBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>
							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreatePoint('FixedJoint');" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable FixedJoint-Block" name="FixedJointBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>

							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreatePoint('XSupport');" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable XSupport-Block" name="XSupportBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>
							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreatePoint('YSupport');" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable YSupport-Block" name="YSupportBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>
							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreatePoint('PinSupport');" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable PinSupport-Block" name="PinSupportBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>
							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreatePoint('FixedSupport');" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable FixedSupport-Block" name="FixedSupportBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>
						</div>

					</div>

					<div class="Panel" id="ForcelPanel">
						<h3>Force Panel</h3>
						<div class="PanelContent" id="ForcePanelContent">
							<!--Truss Block-->
							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreateForce('YForce');" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable YForce-Block" name="YForceBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>
							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreateForce('XForce');" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable XForce-Block" name="XForceBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>
							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreateForce('MForce');" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable MForce-Block" name="MForceBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>
							<a href="javascript:CreateMember('Cancel'), CreatePoint('Cancel'), CreateForce('Cancel'), CreateDForce();" class="Tool-Box-Block"> <canvas class="Tool-Box-Block-Canvas left ui-draggable DForce-Block" name="DForceBlock" width="42" height="42" style="position: relative; left: 0px; top: 0px;"></canvas> </a>

						</div>

					</div>

				</div>
			</div>

			<div class="Viewport-Container">

				<div class="Viewport-Scrollable">
					<div id="PropertyBar" class="Property-Bar"></div>
					<div class="Viewport">
						<div id="SuperCanvas" class="Inline-Hint-Canvas">

							<div class="Drawing-Canvas">
								<div class="Obj-Canvas" id="ObjCanvas"></div>
								<canvas id="GridCanvas" class="Grid-Canvas" style="width: 100%; height: 100%;"></canvas>
							</div>
						</div>

					</div>
					</dvi>

				</div>
			</div>

		</div>

		<div class="Bottom-Bar">
			<div id="CoordinateBar"></div>
			<div id="CommandBar"></div>
		</div>

		<!--draw some shapes for the panel-->
		<script type="text/javascript">
			//member block
			var MemberBlock = document.getElementsByName("MemberBlock");
			var ctx = MemberBlock[0].getContext("2d");
			ctx.strokeStyle = "black";
			ctx.moveTo(4, 21);
			ctx.lineTo(38, 21);
			ctx.stroke();

			//hinge block
			var HingeBlock = document.getElementsByName("HingeBlock");
			var ctx = HingeBlock[0].getContext("2d");
			ctx.beginPath();
			ctx.arc(21, 21, 10, 0, 2 * Math.PI, false);
			ctx.fillStyle = "white";
			ctx.fill();
			ctx.lineWidth = 2;
			ctx.strokeStyle = "black";
			ctx.stroke();

			//fixed joint block
			var block = document.getElementsByName("FixedJointBlock");
			var ctx = block[0].getContext("2d");
			ctx.beginPath();
			ctx.arc(21, 21, 10, 0, 2 * Math.PI, false);
			ctx.fillStyle = "black";
			ctx.fill();
			ctx.lineWidth = 2;
			ctx.strokeStyle = "black";
			ctx.stroke();

			//x support block
			var block = document.getElementsByName("XSupportBlock");
			var ctx = block[0].getContext("2d");
			ctx.beginPath();
			ctx.arc(21, 21, 10, 0, 2 * Math.PI, false);
			ctx.fillStyle = "blue";
			//ctx.fill();
			ctx.lineWidth = 2;
			ctx.strokeStyle = "black";
			ctx.stroke();
			ctx.font = "bold 12px sans-serif";
			ctx.textBaseline = "middle";
			ctx.fillStyle = "black";
			ctx.fillText("X", 17.5, 22);

			//Y support block
			var block = document.getElementsByName("YSupportBlock");
			var ctx = block[0].getContext("2d");
			ctx.beginPath();
			ctx.arc(21, 21, 10, 0, 2 * Math.PI, false);
			ctx.fillStyle = "blue";
			//ctx.fill();
			ctx.lineWidth = 2;
			ctx.strokeStyle = "black";
			ctx.stroke();
			ctx.font = "bold 12px sans-serif";
			ctx.textBaseline = "middle";
			ctx.fillStyle = "black";
			ctx.fillText("Y", 17.5, 22);

			//pin support block
			var PinSupportBlock = document.getElementsByName("PinSupportBlock");
			var ctx = PinSupportBlock[0].getContext("2d");
			ctx.beginPath();
			ctx.moveTo(21.5, 11.5);
			// give the (x,y) coordinates
			ctx.lineTo(11.5, 31);
			ctx.lineTo(31.5, 31);
			ctx.lineTo(21.5, 11.5);
			ctx.fillStyle = "red";
			//ctx.fill();
			ctx.lineWidth = 2;
			ctx.strokeStyle = "black";
			ctx.stroke();

			//fixed support block
			var FixedSupportBlock = document.getElementsByName("FixedSupportBlock");
			var ctx = FixedSupportBlock[0].getContext("2d");
			ctx.lineWidth = 2;
			ctx.strokeStyle = "black";
			ctx.strokeRect(11, 6, 20, 30);
			//lines inside
			ctx.beginPath();
			ctx.moveTo(12, 6);
			ctx.lineTo(31, 15);
			ctx.moveTo(12, 15);
			ctx.lineTo(31, 25);
			ctx.moveTo(12, 25);
			ctx.lineTo(31, 35);
			ctx.stroke();

			var block = document.getElementsByName("YForceBlock");
			var ctx = block[0].getContext("2d");
			ctx.beginPath();
			ctx.lineWidth = 2;
			ctx.moveTo(21, 10);
			ctx.lineTo(21, 32);
			ctx.moveTo(13, 23);
			ctx.lineTo(21, 32);
			ctx.moveTo(29, 23);
			ctx.lineTo(21, 32);
			ctx.stroke();

			var block = document.getElementsByName("XForceBlock");
			var ctx = block[0].getContext("2d");
			ctx.beginPath();
			ctx.lineWidth = 2;
			ctx.moveTo(10, 21);
			ctx.lineTo(32, 21);
			ctx.moveTo(23, 13);
			ctx.lineTo(32, 21);
			ctx.moveTo(23, 29);
			ctx.lineTo(32, 21);
			ctx.stroke();

			var block = document.getElementsByName("MForceBlock");
			var ctx = block[0].getContext("2d");
			ctx.beginPath();
			ctx.arc(21, 21, 10, .5 * Math.PI, 2 * Math.PI, false);
			ctx.lineWidth = 2;
			ctx.stroke();

			ctx.beginPath();
			ctx.moveTo(22, 31);
			ctx.lineTo(18, 23);
			ctx.moveTo(22, 31);
			ctx.lineTo(15.5, 36.5);
			ctx.stroke();

			var block = document.getElementsByName("DForceBlock");
			var ctx = block[0].getContext("2d");
			ctx.lineWidth = 2;
			ctx.strokeStyle = "black";
			ctx.strokeRect(6, 11, 30, 20);
			ctx.beginPath();
			ctx.moveTo(12, 11);
			ctx.lineTo(12, 31);
			ctx.moveTo(18, 11);
			ctx.lineTo(18, 31);
			ctx.moveTo(24, 11);
			ctx.lineTo(24, 31);
			ctx.moveTo(30, 11);
			ctx.lineTo(30, 31);
			ctx.stroke();

		</script>

		<script type="text/javascript">
			//SNAP OFF!
			function CreateMember(Type) {

				//If cancel is called, unbind everything
				if(Type == "Cancel") {
					//clear last canvas
					if(document.getElementById("obj" + window.ObjNum) != null) {
						var obj = document.getElementById("obj" + window.ObjNum);
						var ctx = obj.getContext("2d");
						ctx.beginPath();
						ctx.stroke();
						ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
					}
					//unbind everything
					$("#GridCanvas").unbind('mousemove.member', MemberCreationTracker);
					$("#GridCanvas").unbind('click.member', MemberCreationHandler);
					$(document).unbind('keydown.member', CancelMemberCreation);

					//unhighlight member block
					$(".MemberBlock").css("background-color", "transparent");
					$('#CommandBar').html("");
					return 0;
				}

				//Mouse movement tracker
				var MemberCreationTracker = function(e) {
					var mouseTrack = getMousePos(gridcanvas, e, $(".Viewport-Scrollable"), window.DrawingHeight);

					var obj = document.getElementById("obj" + window.ObjNum);
					var ctx = obj.getContext("2d");

					ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);

					//starting Point
					ctx.beginPath();
					ctx.arc(abs_coordinates[0][0], abs_coordinates[0][1], 3, 0, 2 * Math.PI, false);
					ctx.fillStyle = "#8ED6FF";
					ctx.fill();
					ctx.lineWidth = 1;
					ctx.strokeStyle = "black";
					ctx.stroke();

					if(window.Snapping == 'true') {
						ctx.beginPath();
						ctx.moveTo(abs_coordinates[0][0], abs_coordinates[0][1]);
						ctx.lineTo(mouseTrack.AbsSnapX, mouseTrack.AbsSnapY);
						ctx.stroke();
					} else {
						ctx.beginPath();
						ctx.moveTo(abs_coordinates[0][0], abs_coordinates[0][1]);
						ctx.lineTo(mouseTrack.absoluteX, mouseTrack.absoluteY);
						ctx.stroke();
					}

				}
				var MemberCreationHandler = function(evt) {
					var mousePos = getMousePos(gridcanvas, evt, $(".Viewport-Scrollable"), window.DrawingHeight);
					if(window.Snapping == "true") {
						var firstX = mousePos.snapX;
						var firstY = mousePos.snapY;
					} else {
						var firstX = (mousePos.adjustedX / 15).toFixed(3);
						var firstY = (mousePos.adjustedY / 15).toFixed(3);
					}

					//message = "First Coordinate:" + firstX + "," + firstY + ", ABS SNAP" + mousePos.AbsSnapX + "," + mousePos.AbsSnapY + ", ABS" + mousePos.absoluteX + ',' + mousePos.absoluteY;
					message = "First Coordinate:" + firstX + "," + firstY;
					$('#CommandBar').html(message);

					//For User and server coords
					point = new Array();
					if(window.Snapping == 'true') {
						point.push(mousePos.snapX);
						point.push(mousePos.snapY);
						coordinates.push(point);
					} else {
						point.push((mousePos.adjustedX / 15).toFixed(3));
						point.push((mousePos.adjustedY / 15).toFixed(3));
						coordinates.push(point);
					}

					//For displaying coords
					abs_point = new Array();
					if(window.Snapping == 'true') {
						abs_point.push(mousePos.AbsSnapX);
						abs_point.push(mousePos.AbsSnapY);
						abs_coordinates.push(abs_point);
					} else {
						abs_point.push(mousePos.absoluteX);
						abs_point.push(mousePos.absoluteY);
						abs_coordinates.push(abs_point);
					}

					//Create First Point
					if(abs_coordinates.length == 1) {

						//check if the canvas already exist
						if(document.getElementById("obj" + window.ObjNum) == null) {
							//If does not exist, create canvas and get context
							str1 = '<canvas id="obj' + window.ObjNum + '" class="Objects" width="' + window.DrawingWidth + '" height="' + window.DrawingHeight + '" style="top:0px; left: 0px; position: absolute;"></canvas>';
							$(str1).appendTo($(".Obj-Canvas"));
							var obj = document.getElementById("obj" + window.ObjNum);
							var ctx = obj.getContext("2d");
						} else {
							//if does, get context and clear
							var obj = document.getElementById("obj" + window.ObjNum);
							var ctx = obj.getContext("2d");
							ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
						}
						//starting point
						ctx.beginPath();
						ctx.arc(abs_coordinates[0][0], abs_coordinates[0][1], 3, 0, 2 * Math.PI, false);
						ctx.fillStyle = "#8ED6FF";
						ctx.fill();
						ctx.lineWidth = 1;
						ctx.strokeStyle = "black";
						ctx.stroke();

						//actual path
						ctx.beginPath();
						ctx.moveTo(abs_coordinates[0][0], abs_coordinates[0][1]);
						ctx.lineTo(abs_coordinates[0][0] + 2, abs_coordinates[0][1] + 2);
						ctx.stroke();
						$("#GridCanvas").bind('mousemove.member', MemberCreationTracker);
					}

					if(coordinates.length >= 2) {
						var obj = document.getElementById("obj" + window.ObjNum);
						var ctx = obj.getContext("2d");
						ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
						
						//store into AllParts and localStorage
						part = new Object();
						part.name= "M"+ObjNum
						part.type = "member";
						part.x1 = abs_coordinates[0][0];
						part.y1 = abs_coordinates[0][1];
						part.x2 = abs_coordinates[1][0];
						part.y2 = abs_coordinates[1][1];
						//for server
						part.servx1 = coordinates[0][0];
						part.servy1 = coordinates[0][1];
						part.servx2 = coordinates[1][0];
						part.servy2 = coordinates[1][1];
						part.e = 300000;
						part.i = 100;
						part.area = 10;
						AllParts.push(part);

						//starting Point
						ctx.beginPath();
						ctx.arc(abs_coordinates[0][0], abs_coordinates[0][1], 3, 0, 2 * Math.PI, false);
						ctx.fillStyle = "#8ED6FF";
						ctx.fill();
						ctx.lineWidth = 1;
						ctx.strokeStyle = "black";
						ctx.stroke();

						//path
						ctx.beginPath();
						ctx.moveTo(abs_coordinates[0][0], abs_coordinates[0][1]);
						ctx.lineTo(abs_coordinates[1][0], abs_coordinates[1][1]);
						ctx.stroke();

						//End Point
						ctx.beginPath();
						ctx.arc(abs_coordinates[1][0], abs_coordinates[1][1], 3, 0, 2 * Math.PI, false);
						ctx.fillStyle = "#8ED6FF";
						ctx.fill();
						ctx.lineWidth = 1;
						ctx.strokeStyle = "black";
						ctx.stroke();
						
						//label
						//label
						ctx.fillStyle = "black";
						ctx.fillText(part.name, Math.abs(part.x1+part.x2)/2, Math.abs(part.y1+part.y2)/2+10);

						

						//localStorage["part" + window.ObjNum] = JSON.stringify(part);

						//alert(JSON.parse(localStorage["part"+window.ObjNum]).x1 );

						//Reset coordinates and abs-coordinates
						var tempAbsPoint = new Array;
						tempAbsPoint.push(abs_coordinates[1][0]);
						tempAbsPoint.push(abs_coordinates[1][1]);
						abs_coordinates.length = 0;
						abs_coordinates.push(tempAbsPoint);

						var tempPoint = new Array;
						tempPoint.push(coordinates[1][0]);
						tempPoint.push(coordinates[1][1]);
						coordinates.length = 0;
						coordinates.push(tempPoint);

						//increase objnum count
						ObjNum++;

						//Continuing Lines
						str1 = '<canvas id="obj' + window.ObjNum + '" class="Objects" width="' + window.DrawingWidth + '" height="' + window.DrawingHeight + '" style="top:0px; left: 0px; position: absolute;"></canvas>';
						$(str1).appendTo($(".Obj-Canvas"));
						var obj = document.getElementById("obj" + window.ObjNum);
						var ctx = obj.getContext("2d");
						//console.log(abs_coordinates[0][0], abs_coordinates[0][1]);
						ctx.beginPath();
						ctx.moveTo(abs_coordinates[0][0], abs_coordinates[0][1]);
						ctx.lineTo(abs_coordinates[0][0] + 2, abs_coordinates[0][1] + 2);
						ctx.stroke();
						$("#GridCanvas").bind('mousemove.member', MemberCreationTracker);
					}

				}
				//start real stuff
				$(".MemberBlock").css("background-color", "#ccc");
				$('#CommandBar').html("Creating: Members Pick First Point:");

				var message;
				var coordinates = new Array();
				var abs_coordinates = new Array();
				var gridcanvas = document.getElementById('GridCanvas');

				$("#GridCanvas").bind('click.member', MemberCreationHandler);

				var CancelMemberCreation = function(e) {
					//if ESC is pressed
					if(e.keyCode == 27) {
						//unbind
						$("#GridCanvas").unbind('mousemove', MemberCreationTracker);
						$("#GridCanvas").unbind('click', MemberCreationHandler);

						$(".MemberBlock").css("background-color", "transparent");
						//clear last canvas
						var obj = document.getElementById("obj" + window.ObjNum);
						var ctx = obj.getContext("2d");
						ctx.beginPath();
						ctx.stroke();
						ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);

						$('#CommandBar').html("");
						//unbind the esc
						$(document).unbind('keydown.member', CancelMemberCreation);
					}
				}
				$(document).bind('keydown.member', CancelMemberCreation);
			}

			function CreatePoint(Type) {
				//If cancel is called
				if(Type == "Cancel") {
					//unbind everything
					//$("#GridCanvas").unbind('mousemove', PointCreationTracker);
					$("#GridCanvas").unbind('click.point', PointCreationHandler);
					$(document).unbind('keydown.point', CancelPointCreation);
					//unhighlight member block
					$(".Tool-Box-Block-Canvas").css("background-color", "transparent");
					$('#CommandBar').html("");
					return 0;
				}

				var PointCreationHandler = function(evt) {
					var mousePos = getMousePos(gridcanvas, evt, $(".Viewport-Scrollable"), window.DrawingHeight);
					if(window.Snapping == "true") {
						var firstX = mousePos.snapX;
						var firstY = mousePos.snapY;

						var absX = mousePos.AbsSnapX;
						var absY = mousePos.AbsSnapY;
					} else {
						var firstX = (mousePos.adjustedX / 15).toFixed(3);
						var firstY = (mousePos.adjustedY / 15).toFixed(3);

						var absX = mousePos.absoluteX;
						var absY = mousePos.absoluteY;
					}

					message = "Point Created at:" + firstX + "," + firstY;
					$('#CommandBar').html(message);

					//Check if there are existing canvas, if not create and get context, else clear
					if(document.getElementById("obj" + window.ObjNum) == null) {
						str1 = '<canvas id="obj' + window.ObjNum + '" class="Objects" width="' + window.DrawingWidth + '" height="' + window.DrawingHeight + '" style="top:0px; left: 0px; position: absolute;"></canvas>';
						$(str1).appendTo($(".Obj-Canvas"));
						var obj = document.getElementById("obj" + window.ObjNum);
						var ctx = obj.getContext("2d");
					} else {
						var obj = document.getElementById("obj" + window.ObjNum);
						var ctx = obj.getContext("2d");
						ctx.beginPath();
						ctx.stroke();
						ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
					}

					//start switch
					switch(Type) {
						case "Hinge":
						//add it to AllParts
							var Part = new Object;
							Part.name= "P"+ObjNum
							Part.x1 = absX;
							Part.y1 = absY;
							Part.servx1 = firstX;
							Part.servy1 = firstY;
							Part.type = "Hinge";
							AllParts.push(Part);
							
							ctx.arc(absX + 0.5, absY + 0.5, 5, 0, 2 * Math.PI, false);
							ctx.fillStyle = "white";
							ctx.fill();
							ctx.lineWidth = 2;
							ctx.strokeStyle = "black";
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, absX-5, absY+20);
							ctx.stroke();
							
							ObjNum++;
							break;
						case "FixedJoint":
						//add it to AllParts
							var Part = new Object;
							Part.name= "P"+ObjNum
							Part.x1 = absX;
							Part.y1 = absY;
							Part.servx1 = firstX;
							Part.servy1 = firstY;
							Part.type = "FixedJoint";
							AllParts.push(Part);
							
							ctx.beginPath();
							ctx.arc(absX + 0.5, absY + 0.5, 5, 0, 2 * Math.PI, false);
							ctx.fillStyle = "black";
							ctx.fill();
							ctx.lineWidth = 2;
							ctx.strokeStyle = "black";
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, absX-5, absY+20);
							ctx.stroke();
							
							ObjNum++;
							break;
						case "XSupport":
						//add it to AllParts
							var Part = new Object;
							Part.name= "S"+ObjNum
							Part.x1 = absX;
							Part.y1 = absY;
							Part.servx1 = firstX;
							Part.servy1 = firstY;
							Part.type = "XSupport";
							AllParts.push(Part);
							
							ctx.beginPath();
							ctx.arc(absX, absY + 7, 7, 0, 2 * Math.PI, false);
							ctx.fillStyle = "blue";
							//ctx.fill();
							ctx.lineWidth = 2;
							ctx.strokeStyle = "black";
							ctx.stroke();
							ctx.font = "bold 12px sans-serif";
							ctx.textBaseline = "middle";
							ctx.fillStyle = "black";
							ctx.fillText("X", absX - 4, absY + 7.5);
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, absX-5, absY+20);
							
							ObjNum++;
							break;
						case "YSupport":
						//add it to AllParts
							var Part = new Object;
							Part.x1 = absX;
							Part.y1 = absY;
							Part.name= "S"+ObjNum
							Part.servx1 = firstX;
							Part.servy1 = firstY;
							Part.type = "YSupport";
							AllParts.push(Part);
							
							ctx.beginPath();
							ctx.arc(absX, absY + 7, 7, 0, 2 * Math.PI, false);
							ctx.fillStyle = "blue";
							//ctx.fill();
							ctx.lineWidth = 2;
							ctx.strokeStyle = "black";
							ctx.stroke();
							ctx.font = "bold 12px sans-serif";
							ctx.textBaseline = "middle";
							ctx.fillStyle = "black";
							ctx.fillText("Y", absX - 4, absY + 7.5);
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, absX-5, absY+20);
							
							ObjNum++;
							break;
						case "PinSupport":
						//add it to AllParts
							var Part = new Object;
							Part.x1 = absX;
							Part.y1 = absY;
							Part.name="S"+ObjNum
							Part.servx1 = firstX;
							Part.servy1 = firstY;
							Part.type = "PinSupport";
							AllParts.push(Part);
						
							ctx.beginPath();
							ctx.moveTo(absX - 0.5, absY - 0.5);
							// give the (x,y) coordinates
							ctx.lineTo(absX - 6.5, absY + 6.5);
							ctx.lineTo(absX + 6.5, absY + 6.5);
							ctx.lineTo(absX - 0.5, absY - 0.5);
							ctx.fillStyle = "red";
							//ctx.fill();
							ctx.lineWidth = 2;
							ctx.strokeStyle = "black";
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, absX-5, absY+20);
							
							ctx.stroke();
							
							ObjNum++;
							break;
						case "FixedSupport":
						//add it to AllParts
							var Part = new Object;
							Part.x1 = absX;
							Part.y1 = absY;
							Part.name= "S"+ObjNum
							Part.servx1 = firstX;
							Part.servy1 = firstY;
							Part.type = "FixedSupport";
							AllParts.push(Part);
							
							ctx.lineWidth = 2;
							ctx.strokeStyle = "black";
							ctx.strokeRect(absX - 5.5, absY - 7.5, 11, 15);
							//lines inside
							ctx.beginPath();
							ctx.moveTo(absX - 5.5, absY - 7.5);
							ctx.lineTo(absX + 5.5, absY - 2.5);
							ctx.moveTo(absX - 5.5, absY - 2.5);
							ctx.lineTo(absX + 5.5, absY + 2.5);
							ctx.moveTo(absX - 5.5, absY + 2.5);
							ctx.lineTo(absX + 5.5, absY + 7.5);
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, absX-5, absY+20);
							
							ctx.stroke();
							
							ObjNum++;
							break;
					}//end switch

				}//end PointCreationHandler
				//Start Real Point Creation
				var block = Type + "-Block"
				$('.' + block).css("background-color", "#ccc");
				var gridcanvas = document.getElementById('GridCanvas');

				$("#GridCanvas").bind('click.point', PointCreationHandler);

				var CancelPointCreation = function(e) {
					//if ESC is pressed
					if(e.keyCode == 27) {
						//unbind
						$("#GridCanvas").unbind('click.point', PointCreationHandler);
						//set colors right
						$("." + block).css("background-color", "transparent");
						$('#CommandBar').html("");
						$(document).unbind('keydown.point', CancelPointCreation);
					}
				}
				$(document).bind('keydown.point', CancelPointCreation);
			}//end pointcreation

			function CreateForce(Type) {
				//If cancel is called
				if(Type == "Cancel") {
					//unbind everything
					//$("#GridCanvas").unbind('mousemove', PointCreationTracker);
					$("#GridCanvas").unbind('click.force', ForceCreationHandler);
					//$(document).unbind('keydown.point', CancelPointCreation);
					//unhighlight member block
					$(".Tool-Box-Block-Canvas").css("background-color", "transparent");
					$('#CommandBar').html("");
					return 0;
				}

				//Force creation handler start
				var ForceCreationHandler = function(evt) {
					//prep for property
					switch(Type) {
						case "YForce":
							var Part = new Object;
							Part.type = "YForce"
							Part.name= "F"+ObjNum
							Part.x1 = 0;
							Part.y1 = 0;
							Part.servx1 = 0;
							Part.servy1 = 0;
							Part.magnitude = 1;
							AllParts.push(Part);
							//alert(AllParts[ObjNum].x1);
							var temparray = new Array;
							temparray.push(ObjNum)
							DisplayProperty(temparray);
							break;
						case "XForce":
							var Part = new Object;
							Part.type = "XForce"
							Part.name= "F"+ObjNum
							Part.x1 = 0;
							Part.y1 = 0;
							Part.servx1 = 0;
							Part.servy1 = 0;
							Part.magnitude = 1;
							AllParts.push(Part);
							var temparray = new Array;
							temparray.push(ObjNum)
							DisplayProperty(temparray);
							break;
						case "MForce":
							var Part = new Object;
							Part.type = "MForce"
							Part.name= "F"+ObjNum
							Part.x1 = 0;
							Part.y1 = 0;
							Part.servx1 = 0;
							Part.servy1 = 0;
							Part.magnitude = 1;
							AllParts.push(Part);
							var temparray = new Array;
							temparray.push(ObjNum)
							DisplayProperty(temparray);
							break;
					}//end switch for property

					//prep for drawing
					var mousePos = getMousePos(gridcanvas, evt, $(".Viewport-Scrollable"), window.DrawingHeight);
					if(window.Snapping == "true") {
						var firstX = mousePos.snapX;
						var firstY = mousePos.snapY;

						var absX = mousePos.AbsSnapX;
						var absY = mousePos.AbsSnapY;
					} else {
						var firstX = (mousePos.adjustedX / 15).toFixed(3);
						var firstY = (mousePos.adjustedY / 15).toFixed(3);

						var absX = mousePos.absoluteX;
						var absY = mousePos.absoluteY;
					}

					message = "Point Created at:" + firstX + "," + firstY;
					$('#CommandBar').html(message);

					//Check if there are existing canvas, if not create and get context, else clear
					if(document.getElementById("obj" + window.ObjNum) == null) {
						str1 = '<canvas id="obj' + window.ObjNum + '" class="Objects" width="' + window.DrawingWidth + '" height="' + window.DrawingHeight + '" style="top:0px; left: 0px; position: absolute;"></canvas>';
						$(str1).appendTo($(".Obj-Canvas"));
						var obj = document.getElementById("obj" + window.ObjNum);
						var ctx = obj.getContext("2d");
					} else {
						var obj = document.getElementById("obj" + window.ObjNum);
						var ctx = obj.getContext("2d");
						ctx.beginPath();
						ctx.stroke();
						ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
					}

					//start switch
					switch(Type) {
						case "YForce":
							ctx.beginPath();
							ctx.lineWidth = 2;
							ctx.moveTo(absX, absY - 15);
							ctx.lineTo(absX, absY);
							ctx.moveTo(absX - 6, absY - 7);
							ctx.lineTo(absX, absY);
							ctx.moveTo(absX, absY);
							ctx.lineTo(absX + 6, absY - 7);
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, absX, absY-20);
							ctx.stroke();
							//Update AllParts
							AllParts[ObjNum].x1 = absX;
							AllParts[ObjNum].y1 = absX;
							AllParts[ObjNum].servx1 = firstX;
							AllParts[ObjNum].servy1 = firstY;
							ObjNum++;
							break;
						case "XForce":
							ctx.beginPath();
							ctx.lineWidth = 2;
							ctx.moveTo(absX - 15, absY);
							ctx.lineTo(absX, absY);
							ctx.moveTo(absX - 7, absY - 6);
							ctx.lineTo(absX, absY);
							ctx.moveTo(absX, absY);
							ctx.lineTo(absX - 7, absY + 6);
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, absX, absY-20);
							ctx.stroke();
							//Update AllParts
							AllParts[ObjNum].x1 = absX;
							AllParts[ObjNum].y1 = absX;
							AllParts[ObjNum].servx1 = firstX;
							AllParts[ObjNum].servy1 = firstY;
							ObjNum++;
							break;
						case "MForce":
							ctx.arc(absX, absY, 6, .5 * Math.PI, 2 * Math.PI, false);
							ctx.lineWidth = 2;
							ctx.stroke();

							ctx.beginPath();
							ctx.moveTo(absX + 2.5, absY + 7.5);
							ctx.lineTo(absX, absY);
							ctx.moveTo(absX + 2.5, absY + 7.5);
							ctx.lineTo(absX - 5, absY + 9);
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, absX, absY-20);
							ctx.stroke();
							//Update AllParts
							AllParts[ObjNum].x1 = absX;
							AllParts[ObjNum].y1 = absX;
							AllParts[ObjNum].servx1 = firstX;
							AllParts[ObjNum].servy1 = firstY;
							ObjNum++;
							break;
					}//end switch
				}//end Force Creation Handler
				//Start Real Force Creation
				var block = Type + "-Block"
				$('.' + block).css("background-color", "#ccc");
				var gridcanvas = document.getElementById('GridCanvas');

				//Bind
				$("#GridCanvas").bind('click.force', ForceCreationHandler);

				var CancelForceCreation = function(e) {
					//if ESC is pressed
					if(e.keyCode == 27) {
						//unbind
						$("#GridCanvas").unbind('click.force', ForceCreationHandler);
						//set colors right
						$("." + block).css("background-color", "transparent");
						$('#CommandBar').html("");
						$(document).unbind('keydown.force', CancelForceCreation);
					}
				}

				$(document).bind('keydown.force', CancelForceCreation);

			}//end Force Creation

			function CreateDForce(Type) {
				//If cancel is called
				if(Type == "Cancel") {
					//unbind everything
					//$("#GridCanvas").unbind('mousemove', PointCreationTracker);
					$("#GridCanvas").unbind('click.dforce', DForceCreationHandler);
					$(".Tool-Box-Block-Canvas").css("background-color", "transparent");
					$('#CommandBar').html("");
					temparray.length = 0;
					window.pastselect.length = 0;
					ClickSelect();
					return 0;
				}

				var DForceCreationHandler = function(evt2) {
					var clickPos = getMousePos(gridcanvas, evt2, $(".Viewport-Scrollable"), DrawingHeight);
					var CloseTo = NearPart(clickPos.absoluteX, clickPos.absoluteY);

					if(CloseTo != -1 && evt2.shiftKey == 0) {
						//keep track of list
						window.pastselect.length = 0;
						window.pastselect.push(CloseTo);
						//Unhighlight then highlight
						ClearClickHighlight();
						ClickHighlightPart(CloseTo);

						//create the d force
						var Part = new Object;
						Part.type = "DForce"
						Part.onmember = window.pastselect[window.pastselect.length - 1]
						Part.r1 = 0;
						Part.r2 = 1;
						Part.x1 = 0;
						Part.y1 = 0;
						Part.x2 = 1;
						Part.y2 = 0;
						Part.servx1 = 0;
						Part.servy1 = 0;
						Part.servx2 = 1
						Part.servy2 = 0;
						Part.f1 = 1;
						Part.f2 = 1;
						Part.name = 'D' + ObjNum
						Part.direction = 'Global-Y';

						//Check if there are existing canvas, if not create and get context, else clear
						if(document.getElementById("obj" + window.ObjNum) == null) {
							str1 = '<canvas id="obj' + window.ObjNum + '" class="Objects" width="' + window.DrawingWidth + '" height="' + window.DrawingHeight + '" style="top:0px; left: 0px; position: absolute;"></canvas>';
							$(str1).appendTo($(".Obj-Canvas"));
							var obj = document.getElementById("obj" + window.ObjNum);
							var ctx = obj.getContext("2d");
						} else {
							var obj = document.getElementById("obj" + window.ObjNum);
							var ctx = obj.getContext("2d");
							ctx.beginPath();
							ctx.stroke();
							ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
						}

						//start drawing
						ctx.lineWidth = 3;
						ctx.strokeStyle = "red";
						x1 = Math.min(AllParts[Part.onmember].x1, AllParts[Part.onmember].x2)
						x2 = Math.max(AllParts[Part.onmember].x1, AllParts[Part.onmember].x2)
						if(Math.min(AllParts[Part.onmember].x1, AllParts[Part.onmember].x2) == AllParts[Part.onmember].x1) {
							y1 = AllParts[Part.onmember].y1
							y2 = AllParts[Part.onmember].y2
						} else {
							y1 = AllParts[Part.onmember].y2
							y2 = AllParts[Part.onmember].y1
						}
						var slope = (y2 - y1) / (x2 - x1);
						//how much to move?
						//first turn
						X12 = Math.sqrt(Math.pow(15, 2) / (1 + (Math.pow((1 / (-1 * slope)), 2))))
						Y12 = X12 * (1 / (-1 * slope))
						if(slope == 0) {
							X12 = 0
							Y12 = -15
						} else if(slope == Number.POSITIVE_INFINITY) {
							X12 = -15
							Y12 = 0
						} else if(slope == Number.NEGATIVE_INFINITY) {
							X12 = 15
							Y12 = 0
						}
						//second turn, indirectly third turn
						X22 = Math.sqrt(Math.pow(15, 2) / (1 + (Math.pow((slope), 2))))
						Y22 = X22 * slope
						if(slope == Number.POSITIVE_INFINITY) {
							X22 = 0
							Y22 = 15
						} else if(slope == Number.NEGATIVE_INFINITY) {
							X22 = 0
							Y22 = -15
						}
						//middle line
						X33 = Math.sqrt(Math.pow(7, 2) / (1 + (Math.pow((slope), 2))))
						Y33 = X33 * slope

						ctx.beginPath();
						ctx.moveTo(x1, y1);
						if(y1 > y2) {
							ctx.lineTo(x1 - X12, y1 - Y12);
							ctx.lineTo(x1 - X12 + X22, y1 - Y12 + Y22)
							ctx.lineTo(x1 + X22, y1 + Y22)
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, (2*x1 - X12 + X22)/2, (2*y1 - Y12 + Y22)/2-10);
							//middle line
							ctx.moveTo(x1 - X12 + X33, y1 - Y12 + Y33)
							ctx.lineTo(x1 - X12 + X33, y1 - Y12 + Y33 + 15)
						} else {
							ctx.lineTo(x1 + X12, y1 + Y12);
							ctx.lineTo(x1 + X12 + X22, y1 + Y12 + Y22)
							ctx.lineTo(x1 + X22, y1 + Y22)
							//label
							
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, (2*x1 + X12 + X22)/2, (2*y1 + Y12 + Y22)/2-10);
							//middle line
							ctx.moveTo(x1 + X12 + X33, y1 + Y12 + Y33)
							ctx.lineTo(x1 + X12 + X33, y1 + Y12 + Y33 + 15)
						}
						ctx.stroke();
						//end drawing

						AllParts.push(Part);
						temparray.push(ObjNum)
						DisplayProperty(temparray);
						ObjNum++
						//end create d force

					} else if(CloseTo != -1 && evt2.shiftKey == 1) {
						//keep track of list
						window.pastselect.push(CloseTo);
						//highlight
						ClickHighlightPart(CloseTo);
						//create d force
						var Part = new Object;
						Part.type = "DForce"
						Part.onmember = window.pastselect[window.pastselect.length - 1]
						Part.r1 = 0;
						Part.r2 = 1;
						Part.x1 = 0;
						Part.y1 = 0;
						Part.x2 = 1;
						Part.y2 = 0;
						Part.servx1 = 0;
						Part.servy1 = 0;
						Part.servx2 = 1
						Part.servy2 = 0;
						Part.f1 = 1;
						Part.f2 = 1;
						Part.name="D"+ObjNum
						Part.direction = 'Global-Y';

						//Check if there are existing canvas, if not create and get context, else clear
						if(document.getElementById("obj" + window.ObjNum) == null) {
							str1 = '<canvas id="obj' + window.ObjNum + '" class="Objects" width="' + window.DrawingWidth + '" height="' + window.DrawingHeight + '" style="top:0px; left: 0px; position: absolute;"></canvas>';
							$(str1).appendTo($(".Obj-Canvas"));
							var obj = document.getElementById("obj" + window.ObjNum);
							var ctx = obj.getContext("2d");
						} else {
							var obj = document.getElementById("obj" + window.ObjNum);
							var ctx = obj.getContext("2d");
							ctx.beginPath();
							ctx.stroke();
							ctx.clearRect(0, 0, window.DrawingWidth, window.DrawingHeight);
						}

						//start drawing
						ctx.lineWidth = 3;
						ctx.strokeStyle = "red";
						x1 = Math.min(AllParts[Part.onmember].x1, AllParts[Part.onmember].x2)
						x2 = Math.max(AllParts[Part.onmember].x1, AllParts[Part.onmember].x2)
						if(Math.min(AllParts[Part.onmember].x1, AllParts[Part.onmember].x2) == AllParts[Part.onmember].x1) {
							y1 = AllParts[Part.onmember].y1
							y2 = AllParts[Part.onmember].y2
						} else {
							y1 = AllParts[Part.onmember].y2
							y2 = AllParts[Part.onmember].y1
						}
						var slope = (y2 - y1) / (x2 - x1);
						//how much to move?
						//first turn
						X12 = Math.sqrt(Math.pow(15, 2) / (1 + (Math.pow((1 / (-1 * slope)), 2))))
						Y12 = X12 * (1 / (-1 * slope))
						if(slope == 0) {
							X12 = 0
							Y12 = -15
						} else if(slope == Number.POSITIVE_INFINITY) {
							X12 = -15
							Y12 = 0
						} else if(slope == Number.NEGATIVE_INFINITY) {
							X12 = 15
							Y12 = 0
						}
						//second turn, indirectly third turn
						X22 = Math.sqrt(Math.pow(15, 2) / (1 + (Math.pow((slope), 2))))
						Y22 = X22 * slope
						if(slope == Number.POSITIVE_INFINITY) {
							X22 = 0
							Y22 = 15
						} else if(slope == Number.NEGATIVE_INFINITY) {
							X22 = 0
							Y22 = -15
						}
						//middle line
						X33 = Math.sqrt(Math.pow(7, 2) / (1 + (Math.pow((slope), 2))))
						Y33 = X33 * slope

						ctx.beginPath();
						ctx.moveTo(x1, y1);
						if(y1 > y2) {
							ctx.lineTo(x1 - X12, y1 - Y12);
							ctx.lineTo(x1 - X12 + X22, y1 - Y12 + Y22)
							ctx.lineTo(x1 + X22, y1 + Y22)
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, (2*x1 - X12 + X22)/2, (2*y1 - Y12 + Y22)/2-10);
							//middle line
							ctx.moveTo(x1 - X12 + X33, y1 - Y12 + Y33)
							ctx.lineTo(x1 - X12 + X33, y1 - Y12 + Y33 + 15)
						} else {
							ctx.lineTo(x1 + X12, y1 + Y12);
							ctx.lineTo(x1 + X12 + X22, y1 + Y12 + Y22)
							ctx.lineTo(x1 + X22, y1 + Y22)
							//label
							ctx.fillStyle = "black";
							ctx.fillText(Part.name, (2*x1 + X12 + X22)/2, (2*y1 + Y12 + Y22)/2-10);
							//middle line
							ctx.moveTo(x1 + X12 + X33, y1 + Y12 + Y33)
							ctx.lineTo(x1 + X12 + X33, y1 + Y12 + Y33 + 15)
						}
						ctx.stroke();

						AllParts.push(Part);
						temparray.push(ObjNum)
						DisplayProperty(temparray);
						ObjNum++
						//end create d force

					} else {
						window.pastselect.length = 0;
						ClearClickHighlight();
						ClearDragHighlight();
						temparray.length = 0
						//Hide Property bar
						HideProperty();
					}

					//$('#CommandBar').html(window.pastselect);

				}
				//Start Real Force Creation
				$('.DForce-Block').css("background-color", "#ccc");
				var gridcanvas = document.getElementById('GridCanvas');
				abs_coordinates = new Array();
				coordinates = new Array();

				window.pastselect.length = 0
				var temparray = new Array;

				//instruction for user
				message = "Please select member to place distributed force and provide force property:";
				$('#CommandBar').html(message);

				//Cancel ClickSelect
				ClickSelect('Cancel')
				ClearClickHighlight();
				//Bind
				$("#GridCanvas").bind('click.dforce', DForceCreationHandler);

				var CancelDForceCreation = function(e) {
					//if ESC is pressed
					if(e.keyCode == 27) {
						//unbind
						$("#GridCanvas").unbind('click.dforce', DForceCreationHandler);
						//clear
						temparray.length = 0;
						window.pastselect.length = 0;
						//set colors right
						$('.DForce-Block').css("background-color", "transparent");
						$('#CommandBar').html("");
						$(document).unbind('keydown.dforce', CancelDForceCreation);
						//re bind
						ClickSelect()
					}
				}

				$(document).bind('keydown.dforce', CancelDForceCreation);

			}
		</script>

		<!--Coordinate tracker-->
		<script type="text/javascript">
			function getMousePos(canvas, evt, ViewportScrollable, DrawingHeight) {
				// get canvas position
				var obj = canvas;
				var top = 0;
				var left = 0;
				while(obj && obj.tagName != 'BODY') {
					top += obj.offsetTop;
					left += obj.offsetLeft;
					obj = obj.offsetParent;
				}

				// return relative mouse position
				var mouseX = evt.clientX - left + window.pageXOffset;
				var mouseY = evt.clientY - top + window.pageYOffset;

				var adjustedX = (ViewportScrollable.scrollLeft() + mouseX);
				var adjustedY = (DrawingHeight - (ViewportScrollable.scrollTop() + mouseY)) - 1;

				//snapX
				if(adjustedX % 15 < 8) {
					snapX = (adjustedX - (adjustedX % 15)) / 15
				} else {
					snapX = (adjustedX + 15 - (adjustedX % 15)) / 15
				}

				//snapY
				if(adjustedY % 15 < 8) {
					snapY = (adjustedY - (adjustedY % 15)) / 15
				} else {
					snapY = (adjustedY + 15 - (adjustedY % 15)) / 15
				}

				//Absolute position of Snap
				var AbsSnapX = snapX * 15;
				var AbsSnapY = (DrawingHeight - 1 - snapY * 15);

				return {
					absoluteX : (ViewportScrollable.scrollLeft() + mouseX),
					absoluteY : (ViewportScrollable.scrollTop() + mouseY),
					adjustedX : adjustedX,
					adjustedY : adjustedY,
					snapX : snapX,
					snapY : snapY,
					AbsSnapX : AbsSnapX,
					AbsSnapY : AbsSnapY
				};

			}
		</script>

	</body>
</html>
